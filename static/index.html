<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Dashboard</title>
    <!-- Vue.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.31/vue.global.min.js"></script>
    <!-- Tailwind CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Motor animations CSS -->
    <link href="/static/css/motor-animations.css" rel="stylesheet">
    <!-- Battery and error indicator styles -->
    <style>
        .robot-button {
            position: relative;
            /* Note: overflow: hidden removed to allow error indicators to show */
        }
        .battery-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            transition: width 0.3s ease;
        }
        .battery-text {
            position: absolute;
            bottom: 4px;
            right: 2px;
            font-size: 9px;
            font-weight: bold;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        .robot-name {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: bold;
        }
        .error-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        /* Error ring animations */
        .ring-offset-1 {
            --tw-ring-offset-width: 1px;
        }
        .ring-offset-2 {
            --tw-ring-offset-width: 2px;
        }
        /* Ensure z-index layers work properly */
        .z-10 {
            z-index: 10;
        }
        .z-20 {
            z-index: 20;
        }
        .z-30 {
            z-index: 30;
        }
        .z-40 {
            z-index: 40;
        }
        .z-50 {
            z-index: 50;
        }
        
        /* New animations for status card */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        .animate-spin {
            animation: spin 2s linear infinite;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Gradient animation for charging */
        @keyframes shimmer {
            0% {
                background-position: -200% center;
            }
            100% {
                background-position: 200% center;
            }
        }
        
        .charging-shimmer {
            background: linear-gradient(
                to right,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            background-size: 200% auto;
            animation: shimmer 1.5s ease-in-out infinite;
        }

        /* Control Drawer Styles - MAIN INTERFACE (sliding drawer) */
        .control-drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: 400px;
            background: white;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: -10px 0 25px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
        }

        .control-drawer.open {
            transform: translateX(0);
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .drawer-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .drawer-toggle-btn {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            z-index: 998;
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .drawer-toggle-btn:hover {
            background: #2563EB;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.6);
        }

        .drawer-toggle-btn.open {
            background: #6B7280;
            right: 420px;
        }

        /* Hide drawer on mobile and small tablets */
        @media (max-width: 1024px) {
            .drawer-toggle-btn,
            .control-drawer,
            .drawer-overlay {
                display: none;
            }
        }

        /* Scrollbar styling for drawer */
        .control-drawer::-webkit-scrollbar {
            width: 6px;
        }

        .control-drawer::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .control-drawer::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .control-drawer::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Drawer animations */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .drawer-enter {
            animation: slideInRight 0.3s ease-out;
        }

        /* Quick action buttons with better UX */
        .drawer-btn {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .drawer-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .drawer-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .drawer-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .drawer-btn:hover::before {
            left: 100%;
        }

        /* Quick toolbar styles */
        .quick-toolbar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 997;
            display: flex;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .quick-toolbar.drawer-open {
            right: 420px;
        }

        .quick-btn {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .quick-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .quick-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Hide quick toolbar on mobile */
        @media (max-width: 1024px) {
            .quick-toolbar {
                display: none;
            }
        }

        /* Tab navigation styles */
        .tab-button {
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #3B82F6;
            color: #3B82F6;
        }
        .tab-button:hover:not(.active) {
            color: #6B7280;
            border-bottom-color: #D1D5DB;
        }
    </style>
    <!-- Component Scripts - Load before main.js -->
    <script src="/static/js/services/MotorDataService.js"></script>
    <script src="/static/js/components/MotorDataComponent.js"></script>
    <script src="/static/js/components/MotorDetailComponent.js"></script>
    <script src="/static/js/components/RobotIndicatorComponent.js"></script>
    <script src="/static/js/components/RobotControlComponent.js"></script>
    <script src="/static/js/components/RobotManagementComponent.js"></script>
    <!-- Main application script -->
    <script src="/static/js/main.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app">
        <!-- Loading State -->
        <div v-if="loading" class="p-6 flex justify-center items-center min-h-screen">
            <p class="text-lg">Loading robot data...</p>
        </div>

        <!-- Error State -->
        <div v-else-if="error" class="p-6 flex flex-col justify-center items-center min-h-screen">
            <p class="text-lg text-red-600 mb-4" v-text="error"></p>
            <button 
                @click="fetchData" 
                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
                Retry
            </button>
        </div>

        <!-- Dashboard Content -->
        <div v-else class="p-6 max-w-6xl mx-auto">
            <!-- Header with Robot Selector and Tabs -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-2xl font-bold">Robot Monitor Dashboard</h1>
                    <div class="flex items-center gap-4">
                        <select
                            v-model="selectedRobot"
                            v-show="activeTab === 'monitor'"
                            class="px-4 py-2 border rounded-lg"
                        >
                            <option v-for="robot in robotNames" :key="robot" :value="robot" v-text="robot"></option>
                        </select>
                        <button 
                            @click="reloadConfig"
                            class="px-3 py-2 bg-gray-500 text-white text-sm rounded hover:bg-gray-600"
                            title="Reload robot configuration"
                        >
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8">
                        <button
                            @click="activeTab = 'monitor'"
                            :class="['tab-button py-2 px-1 font-medium text-sm', 
                                    activeTab === 'monitor' ? 'active' : 'text-gray-500']"
                        >
                            Robot Monitor
                        </button>
                        <button
                            @click="activeTab = 'management'"
                            :class="['tab-button py-2 px-1 font-medium text-sm', 
                                    activeTab === 'management' ? 'active' : 'text-gray-500']"
                        >
                            Fleet Management
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Monitor Tab Content -->
            <div v-show="activeTab === 'monitor'">
                <!-- Updated Configuration Status Banner with Close Button -->
                <div v-if="configLoadTime && !configBannerDismissed" class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                    <div class="flex items-center justify-between">
                        <p class="text-blue-800">
                            Configuration loaded at {{ configLoadTime }} &middot; 
                            {{ robotNames.length }} robots configured &middot; 
                            {{ motorEnabledRobots.length }} with motor capabilities
                        </p>
                        <button 
                            @click="configBannerDismissed = true"
                            class="text-blue-600 hover:text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded p-1"
                            title="Close banner"
                        >
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Compact Error Summary Banner -->
                <div v-if="getAllActiveErrors.length > 0" class="mb-4">
                    <div class="bg-red-50 border border-red-300 rounded-lg p-3">
                        <div class="flex items-center justify-between cursor-pointer" @click="errorSummaryExpanded = !errorSummaryExpanded">
                            <div class="flex flex-col sm:flex-row sm:items-center">
                                <div class="flex items-center mb-1 sm:mb-0">
                                    <svg class="h-5 w-5 mr-2 text-red-600 error-pulse flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                    <h3 class="text-sm font-semibold text-red-800">
                                        <span v-text="getAllActiveErrors.length"></span> Active Error<span v-if="getAllActiveErrors.length > 1">s</span>
                                        on <span v-text="getRobotsWithErrors.length"></span> Robot<span v-if="getRobotsWithErrors.length > 1">s</span>
                                    </h3>
                                </div>
                                <div class="ml-7 sm:ml-4 flex items-center gap-2 text-xs">
                                    <span v-for="errorGroup in getGroupedErrors.slice(0, 3)" :key="errorGroup.code" 
                                        class="relative px-3 py-1 bg-gray-100 text-gray-700 rounded-full border border-gray-200">
                                        <span v-text="errorGroup.code" class="font-mono text-xs"></span>
                                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center font-bold">
                                            <span v-text="errorGroup.robots.length"></span>
                                        </span>
                                    </span>
                                    <span v-if="getGroupedErrors.length > 3" class="text-gray-500 text-xs">
                                        +<span v-text="getGroupedErrors.length - 3"></span>
                                    </span>
                                </div>
                            </div>
                            <svg :class="['h-4 w-4 text-gray-600 transform transition-transform flex-shrink-0', errorSummaryExpanded ? 'rotate-180' : '']" 
                                 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        
                        <!-- Expandable Details -->
                        <div v-if="errorSummaryExpanded" class="mt-3 pt-3 border-t border-red-200">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                <div v-for="errorGroup in getGroupedErrors" :key="errorGroup.code" 
                                     class="text-xs p-2 rounded bg-white border border-red-200">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold flex items-center gap-1">
                                            <span class="text-gray-500">#</span><span v-text="errorGroup.code"></span>
                                        </span>
                                        <span class="flex items-center gap-1">
                                            <span :class="[
                                                'w-2 h-2 rounded-full', 
                                                errorDefinitions[errorGroup.code]?.type === 'critical' ? 'bg-red-500' : 'bg-orange-500'
                                            ]"></span>
                                            <span class="text-xs text-gray-600" v-text="getErrorTypeName(errorGroup.code)"></span>
                                        </span>
                                    </div>
                                    <p class="text-gray-700 mb-1" v-text="errorGroup.message"></p>
                                    <p class="text-gray-600">
                                        Robots: <span class="font-medium" v-text="errorGroup.robots.join(', ')"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Robot Grid for Mobile Only (shown after error banner) -->
                <div class="w-full p-4 mb-6 bg-white rounded-lg shadow md:hidden">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Robot Status Overview</h3>
                    <div class="flex flex-wrap justify-center gap-2">
                        <robot-indicator-component
                            v-for="robot in robotNames"
                            :key="robot + '-mobile'"
                            :update-key="motorUpdateKey"
                            :robot-name="robot"
                            :is-selected="selectedRobot === robot"
                            :is-online="robotData.pingStatus[robot]"
                            :robot-status="robotData.robotStatus[robot]"
                            @select-robot="selectedRobot = $event"
                        ></robot-indicator-component>
                    </div>
                </div>

                <!-- Status Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- Connection Status Card -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b">
                            <h2 class="text-lg font-semibold">Connection Status</h2>
                        </div>
                        <div class="px-6 py-4">
                            <div :class="['inline-block px-4 py-2 rounded-full font-semibold', 
                                         robotData.pingStatus[selectedRobot] ? 
                                         'bg-green-100 text-green-800' : 
                                         'bg-red-100 text-red-800']"
                                 v-text="robotData.pingStatus[selectedRobot] ? 'Online' : 'Offline'">
                            </div>
                        </div>
                    </div>

                    <!-- Robot Status Overview Card -->
                    <div class="bg-white shadow rounded-lg overflow-hidden">
                        <div class="px-6 py-4 border-b bg-gradient-to-r from-blue-50 to-blue-100">
                            <h2 class="text-lg font-semibold flex items-center gap-2">
                                <svg class="h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                                </svg>
                                {{ selectedRobot }} Status
                            </h2>
                        </div>
                        <div class="px-6 py-4">
                            <!-- Main Status Display -->
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <!-- Status Icon with Animation -->
                                    <div :class="['p-3 rounded-full', getStatusIconBackground()]">
                                        <svg v-if="getRobotWorkingStatus() === 'cleaning'" 
                                             :class="['h-8 w-8', getStatusIconColor(), 'animate-spin']" 
                                             xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                                        </svg>
                                        <svg v-else-if="getRobotWorkingStatus() === 'charging'" 
                                             :class="['h-8 w-8', getStatusIconColor(), 'animate-pulse']" 
                                             xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                                        </svg>
                                        <svg v-else-if="getRobotWorkingStatus() === 'navigation'" 
                                             :class="['h-8 w-8', getStatusIconColor()]" 
                                             xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                        </svg>
                                        <svg v-else-if="!robotData.pingStatus[selectedRobot]" 
                                             :class="['h-8 w-8', getStatusIconColor()]" 
                                             xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l6.921 6.922c.05.062.105.118.168.167l6.91 6.911a1 1 0 001.415-1.414l-.675-.675a9.001 9.001 0 00-.668-11.982A1 1 0 1014.95 5.05a7.002 7.002 0 01.657 9.143l-1.435-1.435a5.002 5.002 0 00-.596-6.342A1 1 0 0012.18 7.8l-.734.733-7.75-7.75zM5.05 14.95a9.003 9.003 0 01-.668-11.982A1 1 0 102.95 4.383a7.002 7.002 0 00.657 9.144l1.443-1.443z" clip-rule="evenodd" />
                                        </svg>
                                        <svg v-else 
                                             :class="['h-8 w-8', getStatusIconColor()]" 
                                             xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    
                                    <!-- Status Text -->
                                    <div>
                                        <p :class="['text-2xl font-bold capitalize', getStatusTextColor()]">
                                            {{ getStatusDisplayText() }}
                                        </p>
                                        <p class="text-sm text-gray-500">
                                            <span v-if="robotData.pingStatus[selectedRobot]">Online</span>
                                            <span v-else>Offline</span>
                                            <span v-if="robotData.robotStatus[selectedRobot]?.soft_estop_engaged" class="text-red-600 font-semibold"> &middot; E-Stop Active</span>
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Refresh Button -->
                                <button 
                                    @click="refreshData"
                                    :class="['p-2 rounded-full transition-all hover:scale-110', robotData.pingStatus[selectedRobot] ? 'bg-blue-100 hover:bg-blue-200 text-blue-600' : 'bg-gray-100 hover:bg-gray-200 text-gray-600']"
                                    title="Refresh data"
                                >
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Battery Level -->
                            <div v-if="robotData.pingStatus[selectedRobot] && robotData.robotStatus[selectedRobot]?.battery_soc !== undefined" class="mb-4">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-medium text-gray-700">Battery Level</span>
                                    <span :class="['text-sm font-bold', getBatteryTextColor()]">
                                        {{ robotData.robotStatus[selectedRobot].battery_soc }}%
                                    </span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                    <div 
                                        :class="['h-full transition-all duration-500 relative', getBatteryBarColor()]" 
                                        :style="{width: robotData.robotStatus[selectedRobot].battery_soc + '%'}"
                                    >
                                        <div v-if="getRobotWorkingStatus() === 'charging'" class="absolute inset-0 charging-shimmer"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Stats Grid -->
                            <div v-if="robotData.pingStatus[selectedRobot]" class="grid grid-cols-2 gap-3 mb-4">
                                <!-- Cleaning Time -->
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-500 mb-1">Cleaning Time</p>
                                    <p class="text-lg font-semibold text-gray-800">
                                        {{ formatCleaningTime(robotData.robotStatus[selectedRobot]?.cleaning_time_s) }}
                                    </p>
                                </div>
                                
                                <!-- Area Covered -->
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-500 mb-1">Area Covered</p>
                                    <p class="text-lg font-semibold text-gray-800">
                                        {{ formatArea(robotData.robotStatus[selectedRobot]?.area_covered_m2) }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Error Alert -->
                            <div v-if="robotData.pingStatus[selectedRobot] && robotData.robotStatus[selectedRobot]?.watch_doggo_error_rm?.length > 0" 
                                 class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
                                <div class="flex items-start gap-2">
                                    <svg class="h-5 w-5 text-red-600 flex-shrink-0 mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-red-800 mb-1">
                                            {{ robotData.robotStatus[selectedRobot].watch_doggo_error_rm.length }} Active Error<span v-if="robotData.robotStatus[selectedRobot].watch_doggo_error_rm.length > 1">s</span>
                                        </p>
                                        <p class="text-xs text-red-700">
                                            {{ robotData.robotStatus[selectedRobot].watch_doggo_error_rm.map(e => e.error_code).join(', ') }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Last Update Info -->
                            <div class="text-xs text-gray-500 border-t pt-2">
                                Last updated: {{ lastUpdate }}
                            </div>
                        </div>
                    </div>

                    <!-- Motor Status Card -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b">
                            <h2 class="text-lg font-semibold">Motor Status</h2>
                        </div>
                        <div class="px-6 py-4">
                            <motor-data-component
                                v-if="isMotorEnabled(selectedRobot)"
                                :update-key="motorUpdateKey"
                                :robot-name="selectedRobot"
                                :motor-data="robotData.motorData"
                                :is-online="robotData.pingStatus[selectedRobot]"
                                :robot-status="robotData.robotStatus[selectedRobot]"
                            ></motor-data-component>
                            <div v-else class="text-gray-500 text-sm">
                                <p>This robot does not have motor data capabilities.</p>
                                <p class="mt-2 text-xs">To enable motor data, update config.yaml and set has_motors: true</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Robot Grid for Desktop Only (original position) -->
                <div class="w-full p-4 mb-6 hidden md:block">
                    <div class="flex flex-wrap justify-center gap-2">
                        <robot-indicator-component
                            v-for="robot in robotNames"
                            :key="robot + '-desktop'"
                            :update-key="motorUpdateKey"
                            :robot-name="robot"
                            :is-selected="selectedRobot === robot"
                            :is-online="robotData.pingStatus[robot]"
                            :robot-status="robotData.robotStatus[robot]"
                            @select-robot="selectedRobot = $event"
                        ></robot-indicator-component>
                    </div>
                </div>
                
                <!-- Status Data -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Robot Status Data -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b">
                            <h2 class="text-lg font-semibold">Robot Status</h2>
                        </div>
                        <div class="px-6 py-4">
                            <pre class="whitespace-pre-wrap" v-text="JSON.stringify(robotData.robotStatus[selectedRobot] || {}, null, 2)"></pre>
                        </div>
                    </div>

                    <!-- Cleaning Device Status Data -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b">
                            <h2 class="text-lg font-semibold">Cleaning Device Status</h2>
                        </div>
                        <div class="px-6 py-4">
                            <pre class="whitespace-pre-wrap" v-text="JSON.stringify(robotData.cleaningDeviceStatus[selectedRobot] || {}, null, 2)"></pre>
                        </div>
                    </div>
                </div>

                <!-- Motor Data Detailed Tab -->
                <div class="mt-6" v-if="robotData.pingStatus[selectedRobot] && motorDataService.robotHasMotorData(selectedRobot) && isMotorEnabled(selectedRobot)">
                    <motor-detail-component
                        :update-key="motorUpdateKey"
                        :robot-name="selectedRobot"
                        :motor-data="robotData.motorData"
                        :is-online="robotData.pingStatus[selectedRobot]"
                    ></motor-detail-component>
                </div>

                <!-- Robot Control Panel (kept at bottom for mobile/tablet) -->
                <div class="mt-6 lg:hidden">
                    <robot-control-component
                        :robot-name="selectedRobot"
                        :is-online="robotData.pingStatus[selectedRobot]"
                        :robot-status="robotData.robotStatus[selectedRobot]"
                        @command-success="handleControlSuccess"
                        @command-error="handleControlError"
                    ></robot-control-component>
                </div>
                
                <!-- Status Legend -->
                <div class="mt-6 bg-white shadow rounded-lg p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Status Legend</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-green-500 rounded"></div>
                            <span>Cleaning</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-blue-900 rounded"></div>
                            <span>Charging/Idle</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-yellow-500 rounded"></div>
                            <span>Other Status</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-gray-400 rounded"></div>
                            <span>Offline</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-red-500 rounded"></div>
                            <span>E-Stop Active</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-blue-300 rounded border-4 border-blue-300"></div>
                            <span>Has Motor Data</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-yellow-300 rounded border-4 border-yellow-300"></div>
                            <span>Motor Data Pending</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-gray-300 rounded relative">
                                <span class="absolute top-0 right-0 transform translate-x-1/4 -translate-y-1/4 text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center shadow-lg text-white"
                                      style="background-color: #f97316;">3</span>
                            </div>
                            <span>Has Errors</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Management Tab Content -->
            <div v-show="activeTab === 'management'">
                <robot-management-component></robot-management-component>
            </div>
        </div>

        <!-- MAIN UI: Quick Toolbar (Desktop Only) - Only show on monitor tab -->
        <div class="quick-toolbar" :class="{ 'drawer-open': drawerOpen }" v-if="!loading && !error && activeTab === 'monitor'">
            <button
                @click="quickCommand('stop')"
                :disabled="!getCanControl()"
                :class="[
                    'quick-btn',
                    getCanControl()
                        ? 'bg-red-500 hover:bg-red-600 text-white' 
                        : 'bg-gray-100 text-gray-400'
                ]"
                title="Emergency Stop"
            >
                Stop
            </button>
            
            <button
                @click="quickCommand('pause')"
                :disabled="!getCanControl()"
                :class="[
                    'quick-btn',
                    getCanControl()
                        ? 'bg-yellow-500 hover:bg-yellow-600 text-white' 
                        : 'bg-gray-100 text-gray-400'
                ]"
                title="Pause Robot"
            >
                Pause
            </button>
            
            <button
                @click="quickCommand('resume')"
                :disabled="!getCanControl()"
                :class="[
                    'quick-btn',
                    getCanControl()
                        ? 'bg-green-500 hover:bg-green-600 text-white' 
                        : 'bg-gray-100 text-gray-400'
                ]"
                title="Resume Robot"
            >
                Resume
            </button>
        </div>

        <!-- MAIN UI: Drawer Toggle Button (Desktop Only) - Only show on monitor tab -->
        <button 
            class="drawer-toggle-btn" 
            :class="{ open: drawerOpen }"
            @click="toggleDrawer"
            v-if="!loading && !error && activeTab === 'monitor'"
            title="Open Robot Controls"
        >
            <svg v-if="!drawerOpen" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
            </svg>
            <svg v-else class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>

        <!-- MAIN UI: Drawer Overlay - Only show on monitor tab -->
        <div class="drawer-overlay" :class="{ open: drawerOpen }" @click="closeDrawer" v-if="activeTab === 'monitor'"></div>

        <!-- MAIN UI: Control Drawer (Desktop Only) - Only show on monitor tab -->
        <div class="control-drawer" :class="{ open: drawerOpen }" v-if="activeTab === 'monitor'">
            <!-- Drawer Header -->
            <div class="sticky top-0 bg-white border-b border-gray-200 p-4 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <svg class="h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                        </svg>
                        {{ selectedRobot }} Controls
                    </h2>
                    <button 
                        @click="closeDrawer"
                        class="p-1 hover:bg-gray-100 rounded"
                        title="Close controls"
                    >
                        <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <!-- Status Badge -->
                <div class="mt-2 flex items-center gap-2">
                    <span :class="['px-2 py-1 text-xs font-medium rounded-full text-white', getQuickStatusBadgeClass()]">
                        {{ getQuickStatus() }}
                    </span>
                    <span v-if="robotData.robotStatus[selectedRobot]?.battery_soc !== undefined" class="text-sm text-gray-600">
                        Battery: {{ robotData.robotStatus[selectedRobot].battery_soc }}%
                    </span>
                </div>
            </div>

            <!-- Drawer Content -->
            <div class="p-4">
                <!-- Quick Status Alerts -->
                <div v-if="!robotData.pingStatus[selectedRobot]" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                    Robot is offline - controls disabled
                </div>
                
                <div v-if="robotData.robotStatus[selectedRobot]?.soft_estop_engaged" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                    E-Stop is engaged
                </div>
                
                <div v-if="robotData.robotStatus[selectedRobot]?.watch_doggo_error_rm?.length > 0" class="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg text-sm text-orange-800">
                    Robot has {{ robotData.robotStatus[selectedRobot].watch_doggo_error_rm.length }} active error<span v-if="robotData.robotStatus[selectedRobot].watch_doggo_error_rm.length > 1">s</span>
                </div>

                <!-- Emergency Controls -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Emergency Controls</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button
                            @click="releaseEstopComplete()"
                            :disabled="!getCanControl() || !robotData.robotStatus[selectedRobot]?.soft_estop_engaged"
                            :class="[
                                'drawer-btn p-3 rounded-lg font-medium text-sm transition-colors',
                                robotData.robotStatus[selectedRobot]?.soft_estop_engaged && getCanControl()
                                    ? 'bg-red-500 hover:bg-red-600 text-white' 
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            ]"
                        >
                            Release E-Stop
                            <div v-if="estopReleaseLoading" class="inline-block ml-2">
                                <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </button>
                        
                        <button
                            @click="quickCommand('stop')"
                            :disabled="!getCanControl()"
                            :class="[
                                'drawer-btn p-3 rounded-lg font-medium text-sm transition-colors',
                                getCanControl()
                                    ? 'bg-yellow-500 hover:bg-yellow-600 text-white'
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            ]"
                        >
                            Emergency Stop
                        </button>
                    </div>
                </div>

                <!-- Navigation Controls -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Navigation</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button
                            @click="quickCommand('pause')"
                            :disabled="!getCanControl()"
                            :class="[
                                'drawer-btn p-3 rounded-lg font-medium text-sm transition-colors',
                                getCanControl()
                                    ? 'bg-yellow-500 hover:bg-yellow-600 text-white' 
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            ]"
                        >
                            Pause
                        </button>
                        
                        <button
                            @click="quickCommand('resume')"
                            :disabled="!getCanControl()"
                            :class="[
                                'drawer-btn p-3 rounded-lg font-medium text-sm transition-colors',
                                getCanControl()
                                    ? 'bg-green-500 hover:bg-green-600 text-white' 
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            ]"
                        >
                            Resume
                        </button>
                        
                        <button
                            @click="quickCommand('navigate_back_to_dock')"
                            :disabled="!getCanControl()"
                            :class="[
                                'drawer-btn p-3 rounded-lg font-medium text-sm transition-colors col-span-2',
                                getCanControl()
                                    ? 'bg-blue-500 hover:bg-blue-600 text-white' 
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            ]"
                        >
                            Go to Dock
                        </button>
                    </div>
                </div>

                <!-- Charging Controls -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Charging</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button
                            @click="quickCommand('start_charging')"
                            :disabled="!getCanControl() || robotData.robotStatus[selectedRobot]?.is_charging"
                            :class="[
                                'drawer-btn p-3 rounded-lg font-medium text-sm transition-colors',
                                getCanControl() && !robotData.robotStatus[selectedRobot]?.is_charging
                                    ? 'bg-blue-500 hover:bg-blue-600 text-white' 
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            ]"
                        >
                            Start Charging
                        </button>
                        
                        <button
                            @click="quickCommand('stop_charging')"
                            :disabled="!getCanControl() || !robotData.robotStatus[selectedRobot]?.is_charging"
                            :class="[
                                'drawer-btn p-3 rounded-lg font-medium text-sm transition-colors',
                                getCanControl() && robotData.robotStatus[selectedRobot]?.is_charging
                                    ? 'bg-orange-500 hover:bg-orange-600 text-white' 
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            ]"
                        >
                            Stop Charging
                        </button>
                    </div>
                </div>

                <!-- Docking Controls -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Docking</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button
                            @click="quickCommand('docking')"
                            :disabled="!getCanControl()"
                            :class="[
                                'drawer-btn p-3 rounded-lg font-medium text-sm transition-colors',
                                getCanControl()
                                    ? 'bg-purple-500 hover:bg-purple-600 text-white' 
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            ]"
                        >
                            Dock Robot
                        </button>
                        
                        <button
                            @click="quickCommand('undock')"
                            :disabled="!getCanControl()"
                            :class="[
                                'drawer-btn p-3 rounded-lg font-medium text-sm transition-colors',
                                getCanControl()
                                    ? 'bg-purple-500 hover:bg-purple-600 text-white' 
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            ]"
                        >
                            Undock
                        </button>
                    </div>
                </div>

                <!-- Battery & Status Info -->
                <div v-if="robotData.pingStatus[selectedRobot]" class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Robot Info</h3>
                    
                    <div v-if="robotData.robotStatus[selectedRobot]?.battery_soc !== undefined" class="mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Battery Level</span>
                            <span :class="['text-sm font-bold', getBatteryTextColor()]">
                                {{ robotData.robotStatus[selectedRobot].battery_soc }}%
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div 
                                :class="['h-full transition-all duration-500 rounded-full', getBatteryBarColor()]" 
                                :style="{width: robotData.robotStatus[selectedRobot].battery_soc + '%'}"
                            ></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="text-gray-600">Status:</span>
                            <span :class="['font-medium ml-1', getStatusTextColor()]">{{ getQuickStatus() }}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Connection:</span>
                            <span :class="['font-medium ml-1', robotData.pingStatus[selectedRobot] ? 'text-green-600' : 'text-red-600']">
                                {{ robotData.pingStatus[selectedRobot] ? 'Online' : 'Offline' }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-600 mt-3 pt-3 border-t">
                        Last updated: {{ lastUpdate }}
                    </div>
                </div>

                <!-- Advanced Controls Link -->
                <div class="border-t pt-4">
                    <button
                        @click="openFullControls"
                        class="w-full p-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors"
                    >
                        Open Advanced Controls
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, onBeforeUnmount } = Vue;
        
        const app = createApp({
            components: {
                'motor-data-component': MotorDataComponent,
                'motor-detail-component': MotorDetailComponent,
                'robot-indicator-component': RobotIndicatorComponent,
                'robot-control-component': RobotControlComponent,
                'robot-management-component': RobotManagementComponent,
                'robot-row': RobotRow
            },
            
            setup() {
                // State
                const loading = ref(true);
                const error = ref(null);
                const selectedRobot = ref('');
                const lastUpdate = ref('N/A');
                const errorSummaryExpanded = ref(false);
                const configBannerDismissed = ref(false);
                const drawerOpen = ref(false);
                const activeTab = ref('monitor'); // New tab state

                const estopReleaseLoading = ref(false);
                const lastEstopReleaseResult = ref(null);
                
                const robotData = ref({
                    pingStatus: {},
                    robotStatus: {},
                    cleaningDeviceStatus: {},
                    motorData: {}
                });
                
                // Worker status
                const workerActive = ref(!!window.Worker);

                // Dynamic robot configuration
                const robotNames = ref([]);
                const motorEnabledRobots = ref([]);
                const systemConfig = ref({});
                const configLoadTime = ref(null);
                
                // Motor update key for optimized rendering
                let motorUpdateKey = ref(0);
                let dataCleanup = null;
                
                // Error code definitions
                const errorDefinitions = {
                    '1201': { message: 'Motor error', type: 'warning' },
                    '1412': { message: 'Overcurrent - Component 1', type: 'warning' },
                    '1413': { message: 'Overcurrent - Component 2', type: 'warning' },
                    '1414': { message: 'Overcurrent - Component 3', type: 'warning' },
                    '1415': { message: 'Overcurrent - Component 4', type: 'warning' },
                    '1416': { message: 'Roller overtemperature', type: 'critical' },
                    '1417': { message: 'System overtemperature', type: 'critical' },
                    '3605': { message: 'Module MCU disconnected', type: 'critical' }
                };

                // Drawer control methods
                const toggleDrawer = () => {
                    drawerOpen.value = !drawerOpen.value;
                };

                const closeDrawer = () => {
                    drawerOpen.value = false;
                };

                const openFullControls = () => {
                    closeDrawer();
                    // Scroll to full controls section
                    const controlsElement = document.querySelector('.robot-control-component');
                    if (controlsElement) {
                        controlsElement.scrollIntoView({ behavior: 'smooth' });
                    }
                };

                // Quick control methods
                const getCanControl = () => {
                    return robotData.value.pingStatus[selectedRobot.value] && !loading.value;
                };

                const getQuickStatus = () => {
                    if (!robotData.value.pingStatus[selectedRobot.value]) return 'Offline';
                    const status = robotData.value.robotStatus[selectedRobot.value];
                    if (!status) return 'Unknown';
                    if (status.soft_estop_engaged) return 'E-Stop';
                    const workingStatus = (status.working_status || '').toLowerCase();
                    if (workingStatus === 'charging') return 'Charging';
                    if (workingStatus === 'cleaning') return 'Cleaning';
                    if (workingStatus === 'navigation') return 'Moving';
                    if (workingStatus === 'idle') return 'Idle';
                    return workingStatus || 'Unknown';
                };

                const getQuickStatusBadgeClass = () => {
                    if (!robotData.value.pingStatus[selectedRobot.value]) return 'bg-gray-500';
                    const status = robotData.value.robotStatus[selectedRobot.value];
                    if (!status) return 'bg-gray-500';
                    if (status.soft_estop_engaged) return 'bg-red-500';
                    if (status.watch_doggo_error_rm?.length > 0) return 'bg-orange-500';
                    if (status.is_charging) return 'bg-blue-500';
                    const workingStatus = (status.working_status || '').toLowerCase();
                    if (workingStatus === 'cleaning') return 'bg-green-500';
                    return 'bg-yellow-500';
                };

                const quickCommand = async (command) => {
                    if (!getCanControl()) return;
                    
                    try {
                        loading.value = true;
                        const response = await fetch(`/api/robot-control/${command}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                robot_name: selectedRobot.value,
                                ...(command === 'docking' ? { action: 'dock' } : {}),
                                ...(command === 'undock' ? { action: 'undock' } : {})
                            })
                        });
                        
                        if (response.ok) {
                            // Auto refresh after successful command
                            setTimeout(() => {
                                refreshData();
                            }, 1000);
                        }
                    } catch (error) {
                        console.error('Quick command error:', error);
                    } finally {
                        loading.value = false;
                    }
                };
                
                // Load robot configuration from API
                const loadRobotConfig = async () => {
                    try {
                        const response = await fetch('/api/config');
                        if (!response.ok) {
                            throw new Error('Failed to load robot configuration');
                        }
                        
                        const config = await response.json();
                        
                        // Extract robot names
                        robotNames.value = config.robots.map(r => r.name);
                        
                        // Extract motor-enabled robots
                        motorEnabledRobots.value = config.robots
                            .filter(r => r.has_motors)
                            .map(r => r.name);
                            
                        // Store system config
                        systemConfig.value = config.system || {};
                        
                        // Set initial selected robot
                        if (!selectedRobot.value && robotNames.value.length > 0) {
                            selectedRobot.value = robotNames.value[0];
                        }
                        
                        configLoadTime.value = new Date().toLocaleTimeString();
                        
                        console.log(`Loaded ${robotNames.value.length} robots, ${motorEnabledRobots.value.length} with motors`);
                        
                    } catch (err) {
                        console.error('Error loading robot configuration:', err);
                        
                        // Fallback to hardcoded list if config fails
                        robotNames.value = ['base1', 'base2', 'base3', 'base4', 'base5', 'base6',
                                          'base7', 'base8', 'base9', 'base10', 'base11', 'base12',
                                          'base-b2', 'base-b3'];
                        motorEnabledRobots.value = ['base6', 'base7', 'base8', 'base11'];
                        
                        if (!selectedRobot.value) {
                            selectedRobot.value = 'base1';
                        }
                        
                        console.log('Using fallback robot configuration');
                    }
                };
                
                // Check if a robot has motor capabilities
                const isMotorEnabled = (robotName) => {
                    return motorEnabledRobots.value.includes(robotName);
                };
                
                // Reload configuration
                const reloadConfig = async () => {
                    loading.value = true;
                    await loadRobotConfig();
                    await fetchGeneralData();
                    loading.value = false;
                };
                
                // Computed properties for error handling
                const getAllActiveErrors = computed(() => {
                    const allErrors = [];
                    
                    robotNames.value.forEach(robot => {
                        const status = robotData.value.robotStatus[robot];
                        if (status && status.watch_doggo_error_rm && robotData.value.pingStatus[robot]) {
                            status.watch_doggo_error_rm.forEach(error => {
                                allErrors.push({
                                    robot: robot,
                                    code: error.error_code,
                                    message: error.rm_message || errorDefinitions[error.error_code]?.message || 'Unknown error'
                                });
                            });
                        }
                    });
                    
                    return allErrors;
                });
                
                const getRobotsWithErrors = computed(() => {
                    const robotsSet = new Set();
                    getAllActiveErrors.value.forEach(error => {
                        robotsSet.add(error.robot);
                    });
                    return Array.from(robotsSet);
                });
                
                const getGroupedErrors = computed(() => {
                    const grouped = {};
                    
                    getAllActiveErrors.value.forEach(error => {
                        if (!grouped[error.code]) {
                            grouped[error.code] = {
                                code: error.code,
                                message: errorDefinitions[error.code]?.message || error.message,
                                robots: [],
                                count: 0
                            };
                        }
                        
                        if (!grouped[error.code].robots.includes(error.robot)) {
                            grouped[error.code].robots.push(error.robot);
                        }
                        grouped[error.code].count++;
                    });
                    
                    // Sort by severity (critical first) then by count
                    return Object.values(grouped).sort((a, b) => {
                        const aType = errorDefinitions[a.code]?.type || 'warning';
                        const bType = errorDefinitions[b.code]?.type || 'warning';
                        
                        if (aType === 'critical' && bType !== 'critical') return -1;
                        if (bType === 'critical' && aType !== 'critical') return 1;
                        
                        return b.count - a.count;
                    });
                });
                
                // Helper methods for error display
                const getErrorSeverityClass = (errorCode) => {
                    const type = errorDefinitions[errorCode]?.type || 'warning';
                    return type === 'critical' ? 'border-red-400 bg-red-100' : 'border-orange-400 bg-orange-100';
                };

                const getErrorBadgeClass = (errorCode) => {
                    // Return empty string since we're not using colored badges anymore
                    return '';
                };
                                
                const getErrorTypeName = (errorCode) => {
                    const type = errorDefinitions[errorCode]?.type || 'warning';
                    return type === 'critical' ? 'Critical' : 'Warning';
                };
                
                // New helper methods for status display
                const getRobotWorkingStatus = () => {
                    const status = robotData.value.robotStatus[selectedRobot.value];
                    if (!status) return 'unknown';
                    return (status.working_status || '').toLowerCase();
                };
                
                const getStatusDisplayText = () => {
                    if (!robotData.value.pingStatus[selectedRobot.value]) {
                        return 'Offline';
                    }
                    
                    const status = robotData.value.robotStatus[selectedRobot.value];
                    if (!status) return 'Unknown';
                    
                    if (status.soft_estop_engaged) {
                        return 'E-Stop Active';
                    }
                    
                    const workingStatus = getRobotWorkingStatus();
                    if (workingStatus === 'charging') return 'Charging';
                    if (workingStatus === 'cleaning') return 'Cleaning';
                    if (workingStatus === 'navigation') return 'Navigating';
                    if (workingStatus === 'idle') return 'Idle';
                    
                    return workingStatus || 'Unknown';
                };
                
                const getStatusIconBackground = () => {
                    const status = getRobotWorkingStatus();
                    if (!robotData.value.pingStatus[selectedRobot.value]) return 'bg-gray-100';
                    if (robotData.value.robotStatus[selectedRobot.value]?.soft_estop_engaged) return 'bg-red-100';
                    if (status === 'cleaning') return 'bg-green-100';
                    if (status === 'charging') return 'bg-blue-100';
                    if (status === 'navigation') return 'bg-purple-100';
                    if (status === 'idle') return 'bg-gray-100';
                    return 'bg-gray-100';
                };
                
                const getStatusIconColor = () => {
                    const status = getRobotWorkingStatus();
                    if (!robotData.value.pingStatus[selectedRobot.value]) return 'text-gray-400';
                    if (robotData.value.robotStatus[selectedRobot.value]?.soft_estop_engaged) return 'text-red-600';
                    if (status === 'cleaning') return 'text-green-600';
                    if (status === 'charging') return 'text-blue-600';
                    if (status === 'navigation') return 'text-purple-600';
                    if (status === 'idle') return 'text-gray-600';
                    return 'text-gray-600';
                };
                
                const getStatusTextColor = () => {
                    const status = getRobotWorkingStatus();
                    if (!robotData.value.pingStatus[selectedRobot.value]) return 'text-gray-500';
                    if (robotData.value.robotStatus[selectedRobot.value]?.soft_estop_engaged) return 'text-red-600';
                    if (status === 'cleaning') return 'text-green-600';
                    if (status === 'charging') return 'text-blue-600';
                    if (status === 'navigation') return 'text-purple-600';
                    if (status === 'idle') return 'text-gray-700';
                    return 'text-gray-700';
                };
                
                const getBatteryBarColor = () => {
                    const level = robotData.value.robotStatus[selectedRobot.value]?.battery_soc;
                    if (level === undefined) return 'bg-gray-400';
                    if (level < 20) return 'bg-red-500';
                    if (level < 50) return 'bg-yellow-500';
                    return 'bg-green-500';
                };
                
                const getBatteryTextColor = () => {
                    const level = robotData.value.robotStatus[selectedRobot.value]?.battery_soc;
                    if (level === undefined) return 'text-gray-600';
                    if (level < 20) return 'text-red-600';
                    if (level < 50) return 'text-yellow-600';
                    return 'text-green-600';
                };
                
                const formatCleaningTime = (seconds) => {
                    if (!seconds) return '0m';
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    if (hours > 0) {
                        return `${hours}h ${minutes}m`;
                    }
                    return `${minutes}m`;
                };
                
                const formatArea = (area) => {
                    if (!area) return '0 m';
                    return `${area.toFixed(1)} m`;
                };

                // Robot control event handlers
                const handleControlSuccess = (event) => {
                    console.log('Robot control command succeeded:', event);
                    setTimeout(() => {
                        refreshData();
                    }, 1000);
                };

                const handleControlError = (event) => {
                    console.error('Robot control command failed:', event);
                    alert(`Command failed: ${event.error}`);
                };

                const releaseEstopComplete = async () => {
                    if (!getCanControl() || !robotData.value.robotStatus[selectedRobot.value]?.soft_estop_engaged) {
                        return;
                    }

                    // Show confirmation dialog
                    if (!confirm(`Complete E-Stop Release for ${selectedRobot.value}?\n\nThis will:\n1. Reset software e-stop\n2. Enable motor controller\n\nProceed?`)) {
                        return;
                    }

                    estopReleaseLoading.value = true;
                    lastEstopReleaseResult.value = null;

                    try {
                        console.log(`Starting complete e-stop release for ${selectedRobot.value}`);
                        
                        // Use the batch endpoint to execute both commands in sequence
                        const response = await fetch('/api/robot-control/batch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                robot_name: selectedRobot.value,
                                stop_on_error: true,
                                commands: [
                                    {
                                        command: 'reset_soft_estop',
                                        params: {}
                                    },
                                    {
                                        command: 'enable_motor',
                                        params: {}
                                    }
                                ]
                            })
                        });

                        const result = await response.json();
                        lastEstopReleaseResult.value = result;

                        if (response.ok && result.success) {
                            console.log('Complete e-stop release successful:', result);
                            
                            // Show success notification
                            showNotification('success', `E-Stop successfully released for ${selectedRobot.value}`, 5000);
                            
                            // Log the successful operations
                            console.log('Executed commands:');
                            result.results.forEach((cmdResult, index) => {
                                console.log(`  ${index + 1}. ${cmdResult.command}: ${cmdResult.success ? 'SUCCESS' : 'FAILED'}`);
                            });
                            
                            // Refresh robot status after successful release
                            setTimeout(() => {
                                refreshData();
                            }, 1000);
                            
                        } else {
                            console.error('Complete e-stop release failed:', result);
                            
                            // Find which command failed
                            const failedCommands = result.results?.filter(r => !r.success) || [];
                            const failureDetails = failedCommands.length > 0 
                                ? `Failed at: ${failedCommands.map(f => f.command).join(', ')}`
                                : 'Unknown error';
                            
                            showNotification('error', `E-Stop release failed: ${failureDetails}`, 8000);
                        }

                    } catch (error) {
                        console.error('Error during complete e-stop release:', error);
                        showNotification('error', `E-Stop release error: ${error.message}`, 8000);
                        lastEstopReleaseResult.value = { error: error.message };
                    } finally {
                        estopReleaseLoading.value = false;
                    }
                };

                const showNotification = (type, message, duration = 5000) => {
                    // Create a notification element
                    const notification = document.createElement('div');
                    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all transform translate-x-full`;
                    
                    if (type === 'success') {
                        notification.className += ' bg-green-500 text-white';
                    } else if (type === 'error') {
                        notification.className += ' bg-red-500 text-white';
                    } else {
                        notification.className += ' bg-blue-500 text-white';
                    }
                    
                    notification.innerHTML = `
                        <div class="flex items-center">
                            <div class="flex-1">${message}</div>
                            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                                
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Slide in
                    setTimeout(() => {
                        notification.classList.remove('translate-x-full');
                    }, 100);
                    
                    // Auto remove
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.classList.add('translate-x-full');
                            setTimeout(() => {
                                if (notification.parentElement) {
                                    notification.remove();
                                }
                            }, 300);
                        }
                    }, duration);
                };

                
                // Refresh function for manual refresh
                const refreshData = () => {
                    // If using worker, send a message to force immediate poll
                    if (workerActive.value && window.motorDataWorker) {
                        window.motorDataWorker.postMessage({ command: 'poll' });
                    }
                    
                    // Also refresh general data
                    fetchGeneralData();
                };
                
                // Function to fetch general data
                const fetchGeneralData = async () => {
                    try {
                        const response = await fetch(`/api/robot-status?type=general&t=${Date.now()}`);
                        
                        if (!response.ok) {
                            throw new Error(`Server responded with status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        // Update all except motor data (which comes from worker)
                        robotData.value = {
                            ...robotData.value, // Keep motor data from worker
                            pingStatus: data.ping_status || robotData.value.pingStatus || {},
                            robotStatus: data.robot_status || robotData.value.robotStatus || {},
                            cleaningDeviceStatus: data.cleaning_device_status || robotData.value.cleaningDeviceStatus || {}
                        };
                        
                        lastUpdate.value = new Date().toLocaleString();
                        error.value = null;
                        loading.value = false;
                    } catch (err) {
                        console.error('Error fetching general data:', err);
                        error.value = `Failed to load data: ${err.message}`;
                        loading.value = false;
                    }
                };
                
                onMounted(async () => {
                    // Load robot configuration first
                    await loadRobotConfig();
                    
                    // Check if Web Workers are supported
                    if (window.Worker) {
                        console.log('Web Workers are supported - using threaded motor data polling');
                        workerActive.value = true;
                        
                        // Use setupMotorDataWorker from main.js
                        const { cleanup, motorUpdateKey: updateKey } = setupMotorDataWorker(
                            robotData, lastUpdate, error, loading
                        );
                        
                        // Store for cleanup
                        dataCleanup = cleanup;
                        // Assign the update key to our local ref
                        motorUpdateKey = updateKey;
                    } else {
                        console.log('Web Workers are not supported - using main thread polling');
                        workerActive.value = false;
                        
                        // Fall back to the setupMotorDataUpdateRate function
                        fetchGeneralData();
                        
                        // Set up intervals
                        const generalInterval = setInterval(fetchGeneralData, systemConfig.value.update_interval * 1000 || 5000);
                        const motorInterval = setInterval(async () => {
                            try {
                                const response = await fetch(`/api/robot-status?type=motor&t=${Date.now()}`);
                                
                                if (!response.ok) return;
                                
                                const data = await response.json();
                                
                                if (data.motor_data) {
                                    robotData.value.motorData = data.motor_data;
                                    motorUpdateKey.value++;
                                }
                            } catch (err) {
                                console.warn('Error fetching motor data:', err);
                            }
                        }, systemConfig.value.motor_update_interval * 1000 || 1000);
                        
                        // Store cleanup function
                        dataCleanup = () => {
                            clearInterval(generalInterval);
                            clearInterval(motorInterval);
                        };
                    }
                    
                    // Clean up on unmount
                    onBeforeUnmount(() => {
                        if (dataCleanup) {
                            dataCleanup();
                        }
                    });
                });

                return {
                    // State
                    loading,
                    error,
                    selectedRobot,
                    lastUpdate,
                    robotData,
                    robotNames,
                    motorEnabledRobots,
                    systemConfig,
                    configLoadTime,
                    configBannerDismissed,
                    motorUpdateKey,
                    workerActive,
                    errorSummaryExpanded,
                    motorDataService: MotorDataService,
                    drawerOpen,
                    estopReleaseLoading,
                    lastEstopReleaseResult,
                    activeTab,
                    
                    // Methods
                    refreshData,
                    fetchData: fetchGeneralData,
                    isMotorEnabled,
                    reloadConfig,
                    
                    // Error handling
                    getAllActiveErrors,
                    getRobotsWithErrors,
                    getGroupedErrors,
                    getErrorSeverityClass,
                    getErrorBadgeClass,
                    getErrorTypeName,
                    errorDefinitions,
                    
                    // Status display methods
                    getRobotWorkingStatus,
                    getStatusDisplayText,
                    getStatusIconBackground,
                    getStatusIconColor,
                    getStatusTextColor,
                    getBatteryBarColor,
                    getBatteryTextColor,
                    formatCleaningTime,
                    formatArea,

                    // Robot control event handlers
                    handleControlSuccess,
                    handleControlError,

                    // Drawer methods
                    toggleDrawer,
                    closeDrawer,
                    openFullControls,
                    getCanControl,
                    getQuickStatus,
                    getQuickStatusBadgeClass,
                    quickCommand,
                    releaseEstopComplete,
                    showNotification
                };
            },
            
            // Provide the motor data service to all components
            provide() {
                return {
                    motorDataService: MotorDataService
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>